#! python

"""
Modified version of barcode report for use on CCS inputs
"""

from pprint import pformat
import functools
import logging
import json
import os.path as op
import sys

from pbcommand.models import DataStore, FileTypes
from pbcommand.models.report import PlotGroup
from pbcommand.cli import pbparser_runner
from pbcommand.utils import setup_log
from pbcore.io import ConsensusReadSet

from pbreports.report import barcode as barcode_report
from pbreports.report.barcode import (read_inputs, get_barcode_info_parallel,
                                      save_demuxed_dataset_reports)
from pbreports.io.barcode import get_unbarcoded_reads_info
from pbreports.io.specs import load_spec
from pbreports.plot.helper import to_plotgroup
from pbreports.plot.tools import plot_read_lengths_with_cdf

log = logging.getLogger(__name__)
__version__ = "0.2.1"


class Constants(barcode_report.Constants):
    TOOL_ID = "pbreports.tasks.barcode_ccs"
    TOOL_NAME = "barcode_ccs"
    DRIVER_EXE = "python -m pbreports.report.barcode_ccs --resolved-tool-contract"
    VERSION = __version__
    DOC = __doc__
    FILE_TYPE_READS_IN = FileTypes.DS_CCS

    SHOW_COLUMNS = [
        barcode_report.Constants.C_BIOSAMPLE,
        barcode_report.Constants.C_IDX,
        barcode_report.Constants.C_BARCODE,
        barcode_report.Constants.C_NREADS,
        barcode_report.Constants.C_NBASES,
        barcode_report.Constants.C_BCQUAL,
        barcode_report.Constants.C_RANK
    ]

    SHOW_ATTRIBUTES = [
        barcode_report.Constants.A_NBARCODES,
        barcode_report.Constants.A_NREADS_BARCODED,
        barcode_report.Constants.A_NREADS_UNBARCODED,
        barcode_report.Constants.A_MEAN_READS,
        barcode_report.Constants.A_MAX_READS,
        barcode_report.Constants.A_MIN_READS,
        barcode_report.Constants.A_MEAN_RL
    ]


make_report = functools.partial(barcode_report._make_report_impl,
                                Constants.SHOW_ATTRIBUTES,
                                Constants.SHOW_COLUMNS,
                                Constants.LABEL_NONE)


def run_to_report(ds_bc_file,
                  barcodes_file,
                  reads_in_file,
                  base_dir=None,
                  datastore_json=None,
                  nproc=1,
                  test_mode=False,
                  min_bq_filter=Constants.MIN_BQ_FILTER):
    spec = load_spec("barcode")
    inputs = read_inputs(ds_bc_file, barcodes_file, reads_in_file)
    read_info, barcoded_zmws, biosamples, subrpt_files, bc_dataset_uuids = get_barcode_info_parallel(
        inputs.ds_files,
        barcodes_file,
        nproc=nproc,
        subrpt_output_dir=op.join(base_dir, "sub_reports"),
        isoseq_mode=False)
    read_info.extend(list(get_unbarcoded_reads_info(
        inputs.reads_in, barcoded_zmws)))
    if datastore_json is not None:
        save_demuxed_dataset_reports(
            subrpt_files, base_dir, datastore_json)
    else:
        barcode_report.write_empty_datastore(datastore_json)
    rpt = make_report(biosamples=biosamples,
                      read_info=read_info,
                      bc_dataset_uuids=bc_dataset_uuids,
                      dataset_uuids=inputs.dataset_uuids,
                      base_dir=base_dir,
                      use_spec=spec,
                      test_mode=test_mode,
                      min_bq_filter=min_bq_filter)
    return spec.apply_view(rpt)


def args_runner(args):
    log.info("Starting {f} version {v} report generation".format(
        f=__file__, v=__version__))
    report = run_to_report(args.ds_bc, args.barcodes, args.reads_in,
                           base_dir=op.dirname(args.report_json),
                           datastore_json=args.dataset_reports,
                           nproc=args.nproc,
                           test_mode=args.test_mode,
                           min_bq_filter=args.min_bq_filter)
    log.info(pformat(report.to_dict()))
    report.write_json(args.report_json)
    report.tables[0].to_csv(args.report_csv)
    return 0


def resolved_tool_contract_runner(rtc):
    log.info("Starting {f} version {v} report generation".format(
        f=__file__, v=__version__))
    report = run_to_report(
        ds_bc_file=rtc.task.input_files[0],
        barcodes_file=rtc.task.input_files[2],
        reads_in_file=rtc.task.input_files[1],
        base_dir=op.dirname(rtc.task.output_files[0]),
        datastore_json=rtc.task.output_files[2],
        nproc=rtc.task.nproc)
    log.debug(pformat(report.to_dict()))
    report.write_json(rtc.task.output_files[0])
    report.tables[0].to_csv(rtc.task.output_files[1])
    return 0


def _get_parser():
    return barcode_report.get_parser(Constants)


def main(argv=sys.argv):
    return pbparser_runner(
        argv=argv[1:],
        parser=_get_parser(),
        args_runner_func=args_runner,
        contract_runner_func=resolved_tool_contract_runner,
        alog=log,
        setup_log_func=setup_log)


if __name__ == "__main__":
    sys.exit(main(sys.argv))
