
"""
Test that report view metadata fields such as title are populated.  This may
be removed in the future as we try to delegate more of this to the report
view rules and UI.
"""

from pbcommand.models import FileTypes
from pbcommand.pb_io.report import load_report_from_json
from pysiv2.custom.base import TestBase


class TestReportMetadata(TestBase):

    def is_not_none_or_empty_str(self, value, msg):
        self.assertIsNotNone(value, "{} can't be None".format(msg))
        self.assertIsNot(value, "", "{} can't be empty string".format(msg))

    def test_reports_metadata_complete(self):
        """Check that metadata is non-null and nonempty"""
        for file_id, file_info in self.datastore.get_file_dict().iteritems():
            if file_info.file_type_id == FileTypes.REPORT.file_type_id:
                report = load_report_from_json(file_info.path)
                self.is_not_none_or_empty_str(report.id, "Report ID")
                self.is_not_none_or_empty_str(report.title, "Report title")
                for attr in report.attributes:
                    self.is_not_none_or_empty_str(
                        attr.name, "Attribute {} name".format(attr.id))
                for table in report.tables:
                    self.is_not_none_or_empty_str(
                        table.title, "Table {} title".format(table.id))
                    for col in table.columns:
                        self.is_not_none_or_empty_str(
                            col.header, "Column {} header".format(col.id))
                for plotgroup in report.plotGroups:
                    self.is_not_none_or_empty_str(
                        plotgroup.title, "Plotgroup {} title".format(plotgroup.id))
                    for plot in plotgroup.plots:
                        self.is_not_none_or_empty_str(
                            plot.title, "Plot {} title".format(plot.id))
                        self.is_not_none_or_empty_str(
                            plot.caption, "Plot {} caption".format(plot.id))
