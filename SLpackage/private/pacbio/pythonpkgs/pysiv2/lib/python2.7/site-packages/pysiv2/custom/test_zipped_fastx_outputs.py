
"""
Test that zipped FASTQ/FASTA outputs have the expected file names
(JIRA: SL-2924)
"""

import os.path as op
from zipfile import ZipFile

from pbcommand.models import FileTypes
from pbcommand.testkit import pb_requirements

from pysiv2.custom.base import TestValuesLoader

class TestZippedOutputs(TestValuesLoader):
    SOURCE_IDS = {
        "pbcoretools.tasks.bam2fasta_ccs-out-0",
        "pbcoretools.tasks.bam2fastq_ccs-out-0",
        "pbcoretools.tasks.split_laa_fastq-out-0"
    }

    def _verify_prefixes(self, file_name):
        expected_files = set(self.test_values["zip_file_prefixes"])
        with ZipFile(file_name, "r") as zip_in:
            files = {op.splitext(f)[0] for f in zip_in.namelist()}
            self.assertEqual(files, expected_files)

    @pb_requirements("SLT-1803")
    def test_zipped_file_prefixes(self):
        n_tested = 0
        for f_id, file_info in self.datastore.get_file_dict().iteritems():
            if file_info.file_id in self.SOURCE_IDS:
                assert file_info.file_type_id == FileTypes.ZIP.file_type_id
                self._verify_prefixes(file_info.path)
                n_tested += 1
        if n_tested < 1:
            self.fail("Expected at least one zipped output")
