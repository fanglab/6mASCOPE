
from unittest import SkipTest
import logging

from pbcore.io import openDataSet

from pysiv2.custom.base import TestResequencingOutput
from pysiv2.io.datastore import DataStore

log = logging.getLogger(__name__)

class TestUnmappedBam(TestResequencingOutput):

    def test_unmapped_bam_file(self):
        if self.consolidated_alignment_file_name is None:
            raise SkipTest("No gathered AlignmentSet found")
        else:
            mapped = set()
            with openDataSet(self.consolidated_alignment_file_name) as ds:
                for rec in ds:
                    mapped.add(rec.qName)
            for file_id, f in self.datastore.get_file_dict().iteritems():
                if f.file_id == "pbcoretools.tasks.extract_unmapped_bam-out-1":
                    unmapped = {rec.qName for rec in openDataSet(f.path)}
                    self.assertTrue(len(unmapped) > 0)
                    self.assertEqual(len(mapped & unmapped), 0)
                    break
            else:
                self.fail("No unmapped BAM file found")
