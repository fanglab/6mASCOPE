
from collections import Counter

from pbcommand.models import FileTypes
from pbcore.io import ContigSet

from pysiv2.custom.base import TestValuesLoader

class TestConsensusBases(TestValuesLoader):
    """
    Verify that variantCaller was able to call consensus bases, as indicated by
    the presence of uppercase nucleotide characters in the output contigs.
    """

    def test_not_all_lowercase_contigs(self):
        """
        Test that no contigs in the output ContigSet have only lowercase
        characters.
        """
        n_uppercase = 0
        for file_id, file_info in self.datastore.get_file_dict().iteritems():
            if file_info.file_type_id == FileTypes.DS_CONTIG.file_type_id:
                if not file_info.is_chunked:
                    with ContigSet(file_info.path) as contigs:
                        for contig in contigs:
                            c = Counter(contig.sequence)
                            n_uppercase += c['A'] + c['C'] + c['G'] + c['T']
        self.assertTrue(n_uppercase > 0, "All contigs are lowercase-only")
