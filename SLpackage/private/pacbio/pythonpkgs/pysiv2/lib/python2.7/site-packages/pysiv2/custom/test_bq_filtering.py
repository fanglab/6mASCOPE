
"""
Test behavior of barcoding combined with dataset filtering.
"""

from pbcore.io import SubreadSet
from pbcommand.models import FileTypes
from pbcommand.testkit import pb_requirements

from pysiv2.custom.base import TestValuesLoader


class TestBarcodeQualityFilter(TestValuesLoader):

    """
    Test that the number of subreads before and after filtering matches the
    expected values.
    """
    @pb_requirements("SL-2133")
    def test_barcode_quality_filter_applied(self):
        ID1 = "pbcoretools.tasks.datastore_to_subreads"
        ID2 = "pbcoretools.tasks.filterdataset"
        bc_out = self.datastore._get_task_file(ID1, FileTypes.DS_SUBREADS.file_type_id)
        filt_out = self.datastore._get_task_file(ID2, FileTypes.DS_SUBREADS.file_type_id)
        expected = self.test_values["barcoding"]
        with SubreadSet(bc_out) as ds_bc:
            self.assertEqual(len(ds_bc), expected["n_subreads_barcoded"])
            self.assertEqual(len(ds_bc.filters), 1)
        with SubreadSet(filt_out) as ds_filt:
            self.assertEqual(len(ds_filt), expected["n_subreads_filtered"])
            self.assertEqual(len(ds_filt.filters), 1)
